/**
 * Convert Facebook Marketplace category scrape output
 * into the format used by the CrosslistComposer Facebook category picker.
 *
 * Input : scripts/output/facebook-categories.json  (from scrape-facebook-categories.js)
 * Output: src/data/facebookCategories.js            (imported into CrosslistComposer)
 *
 * Usage:
 *   node scripts/convert-fb-categories.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const INPUT  = path.resolve(__dirname, 'output', 'facebook-categories.json');
const OUTPUT = path.resolve(__dirname, '..', 'src', 'data', 'facebookCategories.js');

if (!fs.existsSync(INPUT)) {
  console.error('❌ Input file not found:', INPUT);
  console.error('   Run scrape-facebook-categories.js first.');
  process.exit(1);
}

const raw = JSON.parse(fs.readFileSync(INPUT, 'utf8'));
const categories = raw.categories ?? raw; // handle both wrapped and bare array

/**
 * Each entry in the output array:
 * {
 *   categoryId: string,   // the URL slug (used as the ID stored in facebookForm.categoryId)
 *   categoryName: string, // human-readable name
 *   subcategories?: [...] // same shape, nested
 * }
 *
 * This matches the format already used by the eBay category picker in CrosslistComposer,
 * so the Facebook form can use the same <CategorySelector> component.
 */
function transformCategory(cat) {
  const entry = {
    categoryId: cat.id,
    categoryName: cat.name,
  };

  if (cat.subcategories && cat.subcategories.length > 0) {
    entry.subcategories = cat.subcategories.map(transformCategory);
  }

  return entry;
}

const transformed = categories.map(transformCategory);

const jsContent = `/**
 * Facebook Marketplace Categories
 * Auto-generated by scripts/convert-fb-categories.js
 * Source: scripts/output/facebook-categories.json
 * Scraped: ${raw.scraped_at ?? 'unknown'}
 *
 * DO NOT EDIT MANUALLY – re-run the scraper and converter to update.
 */

export const FACEBOOK_CATEGORIES = ${JSON.stringify(transformed, null, 2)};

export default FACEBOOK_CATEGORIES;
`;

// Ensure src/data/ exists
const dataDir = path.dirname(OUTPUT);
if (!fs.existsSync(dataDir)) fs.mkdirSync(dataDir, { recursive: true });

fs.writeFileSync(OUTPUT, jsContent);

console.log('✅ Converted!');
console.log(`   Categories    : ${transformed.length}`);
console.log(`   Subcategories : ${transformed.reduce((n, c) => n + (c.subcategories?.length ?? 0), 0)}`);
console.log(`   Output        : ${OUTPUT}`);
