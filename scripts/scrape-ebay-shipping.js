/**
 * Scraper: eBay US Domestic Shipping Services
 *
 * Fetches the ShippingServiceCodeType enumeration page from eBay's developer
 * documentation and extracts the US-domestic service names + descriptions,
 * then writes them to src/constants/ebay-shipping.js.
 *
 * Usage:
 *   node scripts/scrape-ebay-shipping.js
 *
 * Requirements: Node.js 18+ (uses built-in fetch)
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const SOURCE_URL =
  'https://developer.ebay.com/devzone/merchant-data/callref/types/ShippingServiceCodeType.html';

// Country prefixes to skip (non-US services)
const COUNTRY_PREFIXES = [
  'AT_', 'AU_', 'BEFR_', 'BENL_', 'CA_', 'CAFR_', 'CanadaPost',
  'CH_', 'CN_', 'DE_', 'ES_', 'FR_', 'HK_', 'IE_', 'IN_',
  'IT_', 'NL_', 'SG_', 'UK_', 'GB_',
];

// Services that are marked as international-only or deprecated/reserved
const SKIP_KEYWORDS = [
  'international', 'reserved for internal', 'ebay on demand', 'eBayNow',
];

// Carriers we know support calculated shipping on eBay US
const CALCULATED_CARRIERS = ['USPS', 'UPS'];
const FLAT_ONLY_CARRIERS = ['FedEx'];

function isUSService(value, description) {
  const lowerDesc = (description || '').toLowerCase();
  if (COUNTRY_PREFIXES.some(p => value.startsWith(p))) return false;
  if (SKIP_KEYWORDS.some(kw => lowerDesc.includes(kw))) return false;
  return true;
}

function guessCarrier(value, description) {
  const v = value.toLowerCase();
  const d = (description || '').toLowerCase();
  if (v.startsWith('usps') || d.includes('usps') || d.includes('postal service')) return 'USPS';
  if (v.startsWith('ups') || d.includes('ups ')) return 'UPS';
  if (v.startsWith('fedex') || d.includes('fedex')) return 'FedEx';
  if (v.startsWith('freight') || d.includes('freight')) return 'Freight';
  if (d.includes('economy') || d.includes('standard') || d.includes('expedited')) return 'eBay';
  return 'Other';
}

async function scrape() {
  console.log(`Fetching: ${SOURCE_URL}`);
  const res = await fetch(SOURCE_URL);
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  const html = await res.text();

  // Parse table rows: <td>VALUE</td><td>DESCRIPTION</td>
  const rowPattern = /<tr[^>]*>[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>[\s\S]*?<\/tr>/gi;
  const services = [];
  let match;

  while ((match = rowPattern.exec(html)) !== null) {
    const value = match[1].replace(/<[^>]+>/g, '').trim();
    const description = match[2].replace(/<[^>]+>/g, '').trim();
    if (!value || value.length < 3) continue;
    if (!isUSService(value, description)) continue;

    const carrier = guessCarrier(value, description);
    const supportsFlat = true; // All valid services support Flat
    const supportsCalculated = CALCULATED_CARRIERS.includes(carrier);

    services.push({ value, label: description || value, carrier, supportsFlat, supportsCalculated });
  }

  // Deduplicate by value
  const seen = new Set();
  const unique = services.filter(s => {
    if (seen.has(s.value)) return false;
    seen.add(s.value);
    return true;
  });

  const flatServices = unique.filter(s => s.supportsFlat);
  const calculatedServices = unique.filter(s => s.supportsCalculated);

  console.log(`Found ${unique.length} US domestic services (${flatServices.length} flat, ${calculatedServices.length} calculated)`);

  // Generate constants file
  const output = `/**
 * eBay US domestic shipping constants
 * AUTO-GENERATED by scripts/scrape-ebay-shipping.js on ${new Date().toISOString()}
 *
 * Source: ${SOURCE_URL}
 *
 * To refresh: node scripts/scrape-ebay-shipping.js
 */

// ---------------------------------------------------------------------------
// Handling Time options (used for both Flat and Calculated shipping)
// ---------------------------------------------------------------------------
export const HANDLING_TIME_OPTIONS = [
  { value: "Same business day", label: "Same business day" },
  { value: "1 business day", label: "1 business day" },
  { value: "2 business days", label: "2 business days" },
  { value: "3 business days", label: "3 business days" },
  { value: "4 business days", label: "4 business days" },
  { value: "5 business days", label: "5 business days" },
  { value: "6 business days", label: "6 business days" },
  { value: "7 business days", label: "7 business days" },
  { value: "10 business days", label: "10 business days" },
  { value: "15 business days", label: "15 business days" },
  { value: "20 business days", label: "20 business days" },
  { value: "30 business days", label: "30 business days" },
  { value: "40 business days", label: "40 business days" },
];

// ---------------------------------------------------------------------------
// Flat rate shipping services
// ---------------------------------------------------------------------------
export const FLAT_SHIPPING_SERVICES = [
${flatServices.map(s => `  { value: ${JSON.stringify(s.value)}, label: ${JSON.stringify(s.label)}, carrier: ${JSON.stringify(s.carrier)} },`).join('\n')}
];

// ---------------------------------------------------------------------------
// Calculated rate shipping services (USPS + UPS only on eBay US)
// ---------------------------------------------------------------------------
export const CALCULATED_SHIPPING_SERVICES = [
${calculatedServices.map(s => `  { value: ${JSON.stringify(s.value)}, label: ${JSON.stringify(s.label)}, carrier: ${JSON.stringify(s.carrier)} },`).join('\n')}
];

export const CARRIER_ORDER = ["eBay", "USPS", "UPS", "FedEx", "Other"];
`;

  const outPath = path.resolve(__dirname, '../src/constants/ebay-shipping.js');
  fs.writeFileSync(outPath, output, 'utf-8');
  console.log(`Written to ${outPath}`);
}

scrape().catch(err => {
  console.error('Scrape failed:', err.message);
  process.exit(1);
});
